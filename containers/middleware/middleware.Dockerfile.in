# Base information.
FROM ci.int.centreon.com:5000/mon-dependencies:centos@CENTOS_VERSION@
MAINTAINER Matthieu Kermagoret <mkermagoret@centreon.com>

# Copy middleware sources.
COPY centreon-imp-portal-api /usr/local/src/centreon-imp-portal-api

# Install OpenLDAP.
RUN yum install -y screen openldap openldap-clients openldap-servers
#RUN echo 'olcRootPW: {SSHA}2pMsLy5/tCfxzQpBah2YWflQdzTKH0Py' >> '/etc/openldap/slapd.d/cn=config/olcDatabase={2}bdb.ldif'
#RUN sed -i 's/dc=acme/dc=centreon/g' '/etc/openldap/slapd.d/cn=config/olcDatabase={2}bdb.ldif'
#RUN sed -i 's/dc=acme/dc=centreon/g' '/etc/openldap/slapd.d/cn=config/olcDatabase={1}monitor.ldif'
#COPY middleware/ldap.ldif /tmp/ldap.ldif

# Install Redis.
RUN yum install -y gcc gcc-c++
RUN wget http://download.redis.io/releases/redis-2.8.24.tar.gz -O /usr/local/src/redis-2.8.24.tar.gz
RUN cd /usr/local/src && tar xzf redis-2.8.24.tar.gz
RUN cd /usr/local/src/redis-2.8.24 && make && make install && cd utils && ./install_server.sh

# Install middleware.
WORKDIR /usr/local/src/centreon-imp-portal-api
COPY middleware/config.js /usr/local/src/centreon-imp-portal-api/config.js
COPY middleware/private.asc /usr/local/src/centreon-imp-portal-api/private.asc
RUN npm install

# Install script.
COPY middleware/content.sql /usr/local/src/imp.sql
COPY middleware/install.sh /tmp/install.sh
RUN chmod +x /tmp/install.sh
RUN /tmp/install.sh

# Entry point.
COPY middleware/run.sh /usr/local/bin/container.sh
ENTRYPOINT /usr/local/bin/container.sh
