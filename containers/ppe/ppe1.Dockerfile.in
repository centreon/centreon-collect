# Base information.
FROM ci.int.centreon.com:5000/mon-dependencies:@DISTRIB@
MAINTAINER Kevin Duret <kduret@centreon.com>

# Copy stable Centreon repo files.
COPY repo/centreon-standard-2.7.@DISTRIB@.repo /etc/yum.repos.d/centreon-standard-2.7.repo

# Prepare environment for autoinstall.
COPY web/autoinstall.php /usr/share/centreon/autoinstall.php

# Install Centreon Web and PPE 1.3.x.
RUN yum remove -y centreon*
RUN yum clean all
RUN yum install --disablerepo='centreon-internal*' -y --nogpgcheck yum install -y --nogpgcheck centreon-base-config-centreon-engine-2.7.5 centreon-2.7.5 centreon-plugins-2.7.5 centreon-plugin-meta-2.7.5 centreon-common-2.7.5 centreon-web-2.7.5 centreon-trap-2.7.5 centreon-perl-libs-2.7.5 mysql-server
COPY centreon-export /usr/share/centreon/www/modules/centreon-export

# Install Centreon (web install).
COPY web/fresh.sh /tmp/fresh.sh
RUN chmod +x /tmp/fresh.sh
RUN /tmp/fresh.sh

# Install module in Centreon.
COPY install-centreon-module.php /tmp/install-centreon-module.php
COPY ppe/ppe1-install.sh /tmp/ppe1-install.sh
RUN chmod +x /tmp/install-centreon-module.php /tmp/ppe1-install.sh
RUN /tmp/ppe1-install.sh

# Main script.
COPY web/run.sh /usr/share/centreon/container.sh
RUN chmod +x /usr/share/centreon/container.sh
ENTRYPOINT ["/usr/share/centreon/container.sh"]
