# Base information.
FROM registry.centreon.com/mon-dependencies-21.10:@DISTRIB@
MAINTAINER Matthieu Kermagoret <mkermagoret@centreon.com>

# Install internal repository.
COPY repo/centreon-internal.repo /etc/yum.repos.d/centreon-internal.repo

# Install Centreon Business repository.
RUN curl -o centreon-business-release.rpm "https://yum.centreon.com/centreon-business/1a97ff9985262bf3daf7a0919f9c59a6/21.10/el7/stable/noarch/RPMS/centreon-business-release-21.10-1.el7.centos.noarch.rpm"
RUN yum clean all && yum install --nogpgcheck centreon-business-release.rpm
RUN sed -i -e 's#yum.centreon.com/centreon-business/1a97ff9985262bf3daf7a0919f9c59a6#srvi-repo.int.centreon.com/yum/business#g' -e 's/enabled=0/enabled=1/g' /etc/yum.repos.d/centreon-business.repo

# Install packages.
RUN yum clean all && yum install centreon-bi-reporting-server MariaDB-server

# Copy configuration files.
COPY mbi/21.10/cbis-profile.xml /etc/centreon-bi/cbis-profile.xml
COPY mbi/21.10/reports-profile.xml /etc/centreon-bi/reports-profile.xml

# Install script.
COPY mbi/21.10/install-server.sh /tmp/install.sh
RUN chmod +x /tmp/install.sh
RUN /tmp/install.sh

# Main script.
COPY mbi/21.10/run.sh /usr/local/bin/container.sh
RUN chmod +x /usr/local/bin/container.sh
ENTRYPOINT ["/usr/local/bin/container.sh"]
