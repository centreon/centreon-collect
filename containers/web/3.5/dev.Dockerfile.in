FROM ci.int.centreon.com:5000/mon-web-3.5:@DISTRIB@
MAINTAINER Matthieu Kermagoret <mkermagoret@centreon.com>

# Install Composer.
RUN curl -sS https://getcomposer.org/installer | php
RUN mv composer.phar /usr/local/bin/composer
RUN chmod +x /usr/local/bin/composer

# Update to the latest Engine and Broker.
COPY centreon/@DISTRIB@/*.rpm /tmp/
RUN yum -y --nogpgcheck '--disablerepo=*' update /tmp/*.rpm
COPY web/3.5/centengine.sh /etc/init.d/centengine
COPY web/3.5/cbd.sh /etc/init.d/cbd
RUN chmod +x /etc/init.d/centengine /etc/init.d/cbd

# Centreon update is made through custom scripts.
COPY web/3.5/container.cnf /etc/my.cnf.d/
COPY web/3.5 /tmp/dev
RUN chmod +x /tmp/dev/dev.sh && \
    chmod 0644 /etc/my.cnf.d/container.cnf
COPY centreon/composer.json /usr/share/centreon/composer.json
RUN composer install -d /usr/share/centreon
COPY centreon/src /usr/share/centreon/src
COPY centreon/bootstrap.php /usr/share/centreon/bootstrap.php
COPY centreon/bin /usr/share/centreon/bin
RUN chmod +x /usr/share/centreon/bin/*
COPY centreon/www/class /usr/share/centreon/www/class
COPY centreon/www/install /usr/share/centreon/www/install
COPY centreon/tmpl/install/sudoersCentreonEngine /etc/sudoers.d/centreon
RUN sed -i 's/@CENTREON_GROUP@/centreon/g' /etc/sudoers.d/centreon
RUN /tmp/dev/dev.sh

# Static sources.
COPY centreon/tmpl/install/centreon.cron /etc/cron.d/centreon
COPY centreon/tmpl/install/centstorage.cron /etc/cron.d/centstorage
COPY centreon/cron /usr/share/centreon/cron
RUN chmod a+x /usr/share/centreon/cron/* && sed -i 's#@CENTREON_ETC@#/etc/centreon#g' /usr/share/centreon/cron/*
COPY centreon/www/sounds /usr/share/centreon/www/sounds
COPY centreon/www/img /usr/share/centreon/www/img
COPY centreon/www/widgets /usr/share/centreon/www/widgets
COPY centreon/www/modules /usr/share/centreon/www/modules
COPY centreon/lib /usr/share/centreon/lib
COPY centreon/www/index.php /usr/share/centreon/www/index.php
COPY centreon/www/main.php /usr/share/centreon/www/main.php
COPY centreon/www/Themes /usr/share/centreon/www/Themes
COPY centreon/www/lib /usr/share/centreon/www/lib
COPY centreon/www/include /usr/share/centreon/www/include
COPY centreon/www/api /usr/share/centreon/www/api
COPY centreon/www/class /usr/share/centreon/www/class
