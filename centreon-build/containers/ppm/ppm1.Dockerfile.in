# Base information.
FROM ci.int.centreon.com:5000/mon-dependencies:@DISTRIB@
MAINTAINER Matthieu Kermagoret <mkermagoret@centreon.com>

# Set middleware server.
ENV CENTREON_IMP_SERVER HELLOWORLD:http://ci.int.centreon.com:3000/api

# Copy stable Centreon repo files.
COPY repo/centreon-standard-2.7.@DISTRIB@.repo /etc/yum.repos.d/centreon-standard-stable.repo
COPY repo/centreon-pluginpacks-2.7.@DISTRIB@.repo /etc/yum.repos.d/centreon-pluginpacks-stable.repo

# Prepare environment for autoinstall.
COPY web/3.4/autoinstall.php /usr/share/centreon/autoinstall.php

# Install Centreon Web and PPM 1.x.
RUN yum remove -y 'centreon*'
RUN yum clean all
RUN yum install -y --nogpgcheck centreon-base-config-centreon-engine-2.7.11 centreon-2.7.11 centreon-plugins-2.7.11 centreon-plugin-meta-2.7.11 centreon-common-2.7.11 centreon-web-2.7.11 centreon-trap-2.7.11 centreon-perl-libs-2.7.11 centreon-pp-manager-1.4.1 mysql-server

# Install Centreon (web install).
COPY web/3.4/fresh.sh /tmp/fresh.sh
RUN chmod +x /tmp/fresh.sh
RUN /tmp/fresh.sh

# Install module in Centreon with old plugin packs.
COPY web/3.4/install-centreon-module.php /tmp/install-centreon-module.php
COPY ppm/ppm1-install.sh /tmp/ppm1-install.sh
RUN chmod +x /tmp/install-centreon-module.php /tmp/ppm1-install.sh
RUN /tmp/ppm1-install.sh
RUN yum install -y --nogpgcheck 'ces-plugins-*'

# Install new repositories.
RUN rm -f /etc/yum.repos.d/centreon-standard-stable.repo /etc/yum.repos.d/centreon-pluginpacks-stable.repo
RUN curl -o centreon-release.rpm "http://yum.centreon.com/standard/3.4/el6/stable/noarch/RPMS/centreon-release-3.4-4.el6.noarch.rpm"
RUN curl -o centreon-plugin-packs-release.rpm "http://yum.centreon.com/plugin-packs/2e83f5ff110c44a9cab8f8c7ebbe3c4f/3.4/el6/stable/noarch/RPMS/centreon-plugin-packs-release-3.4-4.el6.noarch.rpm"
RUN yum clean all && yum install --nogpgcheck centreon-*release.rpm
COPY repo/centreon-internal.repo /etc/yum.repos.d/centreon-internal.repo

# Main script.
COPY web/3.4/run.sh /usr/share/centreon/container.sh
RUN chmod +x /usr/share/centreon/container.sh
ENTRYPOINT ["/usr/share/centreon/container.sh"]
