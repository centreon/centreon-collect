# Base information.
FROM ci.int.centreon.com:5000/mon-dependencies:@DISTRIB@
MAINTAINER Matthieu Kermagoret <mkermagoret@centreon.com>

# Copy stable Centreon repo files.
COPY ces-standard-stable.@DISTRIB@.repo /etc/yum.repos.d/ces-standard-stable.repo
COPY ces-pluginpacks-stable.@DISTRIB@.repo /etc/yum.repos.d/ces-pluginpacks-stable.repo
COPY ces-pluginpacks-unstable.@DISTRIB@.repo /etc/yum.repos.d/ces-pluginpacks-unstable.repo

# Prepare environment for autoinstall.
COPY web/autoinstall.php /usr/share/centreon/autoinstall.php

# Install packages.
RUN yum remove -y centreon*
RUN yum clean all
RUN yum install --disablerepo='ces-*-unstable*' -y --nogpgcheck centreon-pp-manager-1.4.1 mysql-server

# Install Centreon.
COPY web/fresh.sh /tmp/fresh.sh
RUN chmod +x /tmp/fresh.sh
RUN /tmp/fresh.sh

# Install module in Centreon with old plugin packs.
COPY install-centreon-module.php /tmp/install-centreon-module.php
COPY ppm/ppm1-install.sh /tmp/ppm1-install.sh
RUN chmod +x /tmp/install-centreon-module.php /tmp/ppm1-install.sh
RUN /tmp/ppm1-install.sh

# Main script.
COPY web/run.sh /usr/share/centreon/container.sh
RUN chmod +x /usr/share/centreon/container.sh
ENTRYPOINT ["/usr/share/centreon/container.sh"]
