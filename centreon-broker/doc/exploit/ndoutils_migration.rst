##################
NDOUtils migration
##################

Centreon Broker allow to store Nagios events in a database like
NDOUtils. So it is possible to replace NDOUtils by Centreon Broker. This
document will explain how to modify them.

Prerequisites
=============

This migration is base on an architecture with one central and one
poller. The central is define into Centreon by the name "central" and IP
"10.42.0.1", the poller is define by the name "poller" and IP
"10.42.0.2". If we have more than one poller we need to repeat the
poller step. And if we have just one central, bypass the poller step. We
suppose we have a MySQL database on "10.42.0.1" with the user "centreon"
and the password "centreon".

Centreon Broker is assumed to have been properly installed.

**Warning**: When you change NDO to Centrone-Broker you lost your
ack/downtimes history.

Add Centreon Broker informations
--------------------------------

Connect to the Centreon interface and goto in "Configuration" ->
"Centreon", select "Pollers" on the "Main Menu" menu.

For each pollers edit the "Centreon Broker" informations.

================================== =======================================
Information                        Value
================================== =======================================
Centreon Broker configuration path /etc/centreon-broker
Centreon Broker modules path       /usr/share/centreon/lib/centreon-broker
================================== =======================================

Add Centreon Broker configurations
----------------------------------

Connect to the Centreon interface and goto in "Configuration" ->
"Centreon", select "Configuration" on the "Centreon-Broker" menu.

CBD configuration
^^^^^^^^^^^^^^^^^

Add new configuration and set the following informations.

General
"""""""

Set the following information and keep the default value.

================ ==================
Information      Value
================ ==================
Name             central-broker
Config file name central-broker.xml
Requester        central
================ ==================

Input
"""""

Add a "TCP - IPv4" input. Set the following information and keep the
default value.

====================== ====================
Information            Value
====================== ====================
Name                   central-broker-input
Connection port        5668
Serialization Protocol NDO Protocol
====================== ====================

Logger
""""""

Add a "Core - File" logger. Set the following information and keep the
default value.

================== ===========================================
Information        Value
================== ===========================================
Name of the logger /var/log/centreon-broker/central-broker.log
================== ===========================================

Output
""""""

Add a "SQL - Broker SQL Database" output. Set the following information
and keep the default value.

============= =======================
Information   Value
============= =======================
Name          central-broker-sql
DB type       MySQL
Failover Name central-broker-failover
DB host       10.42.0.1
DB Port       3306
DB user       centreon
DB password   centreon
DB name       centreon_storage
============= =======================

Add a "file - File" output. Set the following information and keep the
default value.

======================= ================================================
Information             Value
======================= ================================================
Name                    central-broker-failover
File path               /var/log/centreon-broker/central-broker.failover
Serrialization Protocol NDO Protocol
======================= ================================================

CBMod central configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^

Add new configuration and set the following informations.

General
"""""""

Set the following information and keep the default value.

================ ==================
Information      Value
================ ==================
Name             central-module
Config file name central-module.xml
Requester        central
================ ==================

Logger
""""""

Add a "Core - File" logger. Set the following information and keep the
default value.

================== ===========================================
Information        Value
================== ===========================================
Name of the logger /var/log/centreon-broker/central-module.log
================== ===========================================

Output
""""""

Add a "TCP - IPv4" output. Set the following information and keep the
default value.

======================= =======================
Information             Value
======================= =======================
Name                    central-module-output
Connection port         5668
Host to connect to      10.42.0.1
Failover Name           central-module-failover
Serrialization Protocol NDO Protocol
======================= =======================

Add a "file - File" output. Set the following information and keep the
default value.

======================= ================================================
Information             Value
======================= ================================================
Name                    central-module-failover
File path               /var/log/centreon-broker/central-module.failover
Serrialization Protocol NDO Protocol
======================= ================================================

CBMod poller configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^

Add new configuration and set the following informations.

General
"""""""

Set the following information and keep the default value.

================ =================
Information      Value
================ =================
Name             poller-module
Config file name poller-module.xml
Requester        poller
================ =================

Logger
""""""

Add a "Core - File" logger. Set the following information and keep the
default value.

================== ==========================================
Information        Value
================== ==========================================
Name of the logger /var/log/centreon-broker/poller-module.log
================== ==========================================

Output
""""""

Add a "TCP - IPv4" output. Set the following information and keep the
default value.

======================= ======================
Information             Value
======================= ======================
Name                    poller-module-output
Connection port         5668
Host to connect to      10.42.0.1
Failover Name           poller-module-failover
Serrialization Protocol NDO Protocol
======================= ======================

Add a "file - File" output. Set the following information and keep the
default value.

======================= ===============================================
Information             Value
======================= ===============================================
Name                    poller-module-failover
File path               /var/log/centreon-broker/poller-module.failover
Serrialization Protocol NDO Protocol
======================= ===============================================

Modify Nagios configuration
---------------------------

Connect to the Centreon interface and goto in "Configuration" ->
"Nagios", select "nagios.cfg" on the "Nagios" menu.

Nagios central configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Select the "central" nagios configuration and in the "Data" section line
"Multiple Broker Module", delete the NDO module line. After that you
need to "Add a new broker module".

====================== ================================================================
Information            Value
====================== ================================================================
Multiple Broker Module /usr/lib/nagios/cbmod.so /etc/centreon-broker/central-module.xml
====================== ================================================================

Nagios poller configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^

Select the "poller" nagios configuration and in the "Data" section line
"Multiple Broker Module", delete the NDO module line. After that you
need to "Add a new broker module".

====================== ===============================================================
Information            Value
====================== ===============================================================
Multiple Broker Module /usr/lib/nagios/cbmod.so /etc/centreon-broker/poller-module.xml
====================== ===============================================================

Update Centreon options
-----------------------

Connect to the Centreon interface and goto in "Administration" ->
"Options", select "Options" on the "Main Menu" menu and finally select
"Monitoring". In the "Monitoring database layer" properties update the
"Broker engine used by Centreon".

============================== ===============
Information                    Value
============================== ===============
Broker engine used by Centreon Centreon Broker
============================== ===============

Disable ndomod
--------------

Connect to the Centreon interface and goto in "Configuration" ->
"Centreon", select "ndomod.cfg" on the "NDOUtils" menu.

Select your central-mod and poller-mod configuration and disable it.

Rebuild configuraions
---------------------

Connect to the Centreon interface and goto in "Configuration" ->
"Nagios", select "Generate" on the "Nagios" menu.

Select "All Nagios Servers" into the "Nagios Server" section. After
that, select "Generate Configuration Files" and
"Run Nagios debug (-v)" into the "Actions" section, and "Export" the
configuration.

If all are OK, you can push the configuration, select
"Move Export Files" and "Export" it.

Stop ndo2db
-----------

You need to stop nod2db to release the port 5668, execute the following
command::

  $ /etc/init.d/ndo2db stop

Start CBD
---------

You need to connect on your central serveur by ssh, and execute the
following command::

  $ /etc/init.d/cbd-central-broker start

Restart Nagios
--------------

Now you need to restart All Nagios. Connect to the Centreon interface
and goto in "Configuration" -> "Nagios", select "Generate" on the
"Nagios" menu.

Select "All Nagios Servers" into the "Nagios Server" section. After
that, select "Move Export Files" and "Restart Nagios" section, and
"Export" the configuration.

Move event logs
---------------

Execute the centreon migration tools name "logsMigration.pl" You find
this tools into the centreon installation directory. Path is like
"/usr/share/centreon/www/__INSTALL__/tools/migration/logsMigration.pl"

Patch centstorage
-----------------

Execute the centreon migration patch for centstorage (`patch <http://forge.centreon.com/issues/3265>`_).

Disable ndo2db
--------------

Connect to the Centreon interface and goto in "Configuration" ->
"Centreon", select "ndo2db.cfg" on the "NDOUtils" menu.

Select your central-ndo configuration and disable it.

If you don't want ndo2db starting up automatically don't forget to
remove or disable ndo2db.

CentOS/RedHat
^^^^^^^^^^^^^

Disable ndo2db::

  $ chkconfig --del ndo2db

Remove ndo2db::

  $ yum remove ndoutils

Debian/Ubuntu
^^^^^^^^^^^^^

Disable ndo2db::

  $ update-rc.d ndo2db disable

Remove ndo2db::

  $ apt-get remove ndoutils-common
