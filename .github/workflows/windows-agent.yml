name: Centreon Monitoring Agent Windows build and packaging

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      installer_in_artifact:
        description: 'Save installer and binary in artifacts'
        required: true
        default: false
        type: boolean

  pull_request:
    paths:
      - agent/**
      - custom-triplets/**
      - CMakeLists.txt
      - CMakeListsWindows.txt
      - vcpkg.json
  push:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
    paths:
      - agent/**
      - custom-triplets/**
      - CMakeLists.txt
      - CMakeListsWindows.txt
      - vcpkg.json

jobs:
  get-version:
    uses: ./.github/workflows/get-version.yml
    with:
      version_file: CMakeLists.txt

  build-and-test-agent:
    needs: [get-version]
    runs-on: windows-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.COLLECT_S3_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.COLLECT_S3_SECRET_KEY }}

    steps:
      # in order to have the same checksum between windows-agent and windows-agent-robot-test
      - name: nocrlf conversion
        run: git config --system core.autocrlf false

      - name: Checkout sources
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Compile Agent
        run: .github/scripts/windows-agent-compile.ps1
        shell: powershell

      - name: Common test
        run: |
          cd build_windows
          tests/ut_common

      - name: Agent test
        run: |
          cd build_windows
          tests/ut_agent

      - name: Upload package artifacts
        if: |
          inputs.installer_in_artifact == true ||
          (github.event_name != 'workflow_dispatch' &&
          contains(fromJson('["stable"]'), needs.get-version.outputs.stability) &&
          ! cancelled() &&
          ! contains(needs.*.result, 'failure') &&
          ! contains(needs.*.result, 'cancelled'))
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: packages-centreon-monitoring-agent-windows
          path: agent\installer\centreon-monitoring-agent.exe
