name: Centreon collect

on:
  pull_request_target:
    types:
      - closed
    branches:
      - develop
    paths-ignore:
      - 'gorgone/**'
  workflow_dispatch:
  pull_request:
    paths-ignore:
      - 'gorgone/**'

env:
  REGISTRY: registry-docker.centreon.com/docker-global

jobs:
  create-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - id: version
        run: |
          VERSION=$(awk '$1 ~ "COLLECT_MAJOR" {maj=substr($2, 1, length($2)-1)} $1 ~ "COLLECT_MINOR" {min=substr($2, 1, length($2)-1)} $1 ~ "COLLECT_PATCH" {patch=substr($2, 1, length($2) - 1) ; print maj "." min "." patch}' CMakeLists.txt)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          if [[ -z "$GITHUB_HEAD_REF" ]] ; then
            BRANCHNAME="$GITHUB_REF_NAME"
          else
            BRANCHNAME="$GITHUB_HEAD_REF"
          fi
          case "$BRANCHNAME" in
            master | [2-9][0-9].[0-9][0-9].x | release* | hotfix*)
              echo "release=$GITHUB_RUN_ATTEMPT" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "release=`date +%s`.${{ github.sha }}" >> $GITHUB_OUTPUT
              ;;
          esac
        shell: bash
      - run: |
          echo "Version is ${{ steps.version.outputs.version }}"
          echo "Release is ${{ steps.version.outputs.release }}"
    outputs:
      version: ${{ steps.version.outputs.version }}
      release: ${{ steps.version.outputs.release }}

  centreon-collect-test:
    needs: create-version
    runs-on: [self-hosted, collect]
    env:
      version: ${{ needs.create-version.outputs.version }}
      release: ${{ needs.create-version.outputs.release }}

    strategy:
      matrix:
        include:
          - image: centos7
          - image: alma8
          - image: debian-buster
          - image: debian-bullseye
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REPOS_USERNAME }}
          password: ${{ secrets.REPOS_PASSWORD }}
      - name: Test ${{ matrix.image }}
        uses: ./.github/actions/runner-docker
        with:
          script_name: /src/ci/scripts/collect-unit-tests
          image_name: centreon-collect-${{ matrix.image }}
          image_version: ${{ env.version }}

  rpm-packaging:
    needs: create-version
    runs-on: [self-hosted, collect]
    env:
      version: ${{ needs.create-version.outputs.version }}
      release: ${{ needs.create-version.outputs.release }}

    strategy:
      matrix:
        include:
          - image: centos7
            distrib: el7
          - image: alma8
            distrib: el8
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REPOS_USERNAME }}
          password: ${{ secrets.REPOS_PASSWORD }}

      - name: make rpm ${{ matrix.image }}
        uses: ./.github/actions/runner-docker
        with:
          script_name: /src/ci/scripts/collect-rpm-package
          image_name: centreon-collect-${{ matrix.image }}
          image_version: ${{ env.version }}
          env_variable: -e DISTRIB="${{ matrix.distrib }}" -e VERSION="${{ env.version }}" -e RELEASE="${{ env.release }}"

      - name: Use cache RPM files
        uses: actions/cache@v3
        env:
          cache-name-rpmbuild: cache-${{ github.sha }}-${{ github.run_id }}-rpmbuild-centreon-collect-${{ matrix.distrib }}
        with:
          path: ./*.rpm
          key: ${{ env.cache-name-rpmbuild }}

  debian-packaging:
    needs: create-version
    runs-on: [self-hosted, collect]
    env:
      version: ${{ needs.create-version.outputs.version }}
      release: ${{ needs.create-version.outputs.release }}

    strategy:
      matrix:
        include:
          - image: debian-buster
            distrib: buster
          - image: debian-bullseye
            distrib: bullseye
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          path: centreon-collect
      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REPOS_USERNAME }}
          password: ${{ secrets.REPOS_PASSWORD }}

      - name: debmake ${{ matrix.image }}
        uses: ./centreon-collect/.github/actions/runner-docker
        with:
          script_name: /src/centreon-collect/ci/scripts/collect-deb-package
          image_name: centreon-collect-${{ matrix.image }}
          image_version: ${{ env.version }}
          env_variable: -e DISTRIB="${{ matrix.distrib }}" -e VERSION="${{ env.version }}" -e RELEASE="${{ env.release }}"

      - name: Use cache DEB files
        uses: actions/cache@v3
        env:
          cache-name-debbuild: cache-${{ github.sha }}-${{ github.run_id }}-debbuild-centreon-collect-${{ matrix.distrib }}
        with:
          path: ./*.deb
          key: ${{ env.cache-name-debbuild }}

  delivery-debian:
    needs: [debian-packaging, create-version]
    env:
      version: ${{ needs.create-version.outputs.version }}
    runs-on: ubuntu-22.04
    name: Delivery
    strategy:
      matrix:
        distrib: [buster, bullseye]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

#      - name: Use cache DEB files
#        uses: actions/cache@v3
#        env:
#          cache-name-debbuild: cache-${{ github.sha }}-${{ github.run_id }}-debbuild-centreon-collect-${{ matrix.distrib }}
#        with:
#          path: ./*.deb
#          key: ${{ env.cache-name-debbuild }}
#          restore-keys: |
#            ${{ env.cache-name-debbuild }}

      - name: Publish DEB packages
        uses: ./.github/actions/delivery
        with:
          distrib: ${{ matrix.distrib }}
          version: ${{ env.version }}
          repos_username: ${{ secrets.REPOS_USERNAME }}
          repos_password: ${{ secrets.REPOS_PASSWORD }}
          cache_key: cache-${{ github.sha }}-${{ github.run_id }}

#      - name: Publish DEB to Nexus
#        run: |
#          case $GITHUB_HEAD_REF in
#            MON*)
#              REPO=unstable
#              ;;
#            release* | hotfix*)
#              REPO=testing
#              ;;
#            master | main | [0-9]{2}\.[0-9]{2}.)
#              REPO=stable
#              ;;
#            *)
#              echo -n "[INFO] Non conventional branch name. Please rename your branch to meet the requirements"
#              exit 1
#              ;;
#          esac
#
#          for FILE in *.deb;
#          do
#
#            VERSION=$(echo $FILE | grep -oP '[0-9]{2}\.[0-9]{2}')
#            DISTRIB=${{ matrix.distrib }}
#            ARCH=$(echo $FILE | grep -oP '(amd64)')
#            MODULE=$(echo $FILE | grep -oP 'centreon-([a-z]+)')
#
#            echo "Repo: $REPO"
#            echo "Version: $VERSION"
#            echo "Distrib: $DISTRIB"
#            echo "Arch: $ARCH"
#            echo "Module: $MODULE"
#
#            curl -v -u "${{ secrets.REPOS_USERNAME }}":"${{ secrets.REPOS_PASSWORD }}" -X PUT "https://artifactory.apps.centreon.com/artifactory/debian-$VERSION-$REPO/pool/$FILE;deb.distribution=bullseye;deb.component=main;deb.architecture=amd64" -T "./$FILE"
#          done

  delivery-centos:
    needs: [rpm-packaging, create-version]
    env:
      version: ${{ needs.create-version.outputs.version }}
    runs-on: ubuntu-22.04
    name: Delivery
    strategy:
      matrix:
        distrib: [el7, el8]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

#      - name: Use cache RPM files
#        uses: actions/cache@v3
#        env:
#          cache-name-rpmbuild: cache-${{ github.sha }}-${{ github.run_id }}-rpmbuild-centreon-collect-${{ matrix.distrib }}
#        with:
#          path: ./*.rpm
#          key: ${{ env.cache-name-rpmbuild }}
#          restore-keys: |
#            ${{ env.cache-name-rpmbuild }}

      - name: Publish RPM packages
        uses: ./.github/actions/delivery
        with:
          distrib: ${{ matrix.distrib }}
          version: ${{ env.version }}
          repos_username: ${{ secrets.REPOS_USERNAME }}
          repos_password: ${{ secrets.REPOS_PASSWORD }}
          cache_key: cache-${{ github.sha }}-${{ github.run_id }}

#      - name: Publish RPMS to Nexus
#        run: |
#          case $GITHUB_HEAD_REF in
#            MON*)
#              REPO=unstable
#              ;;
#            release* | hotfix*)
#              REPO=testing
#              ;;
#            master | main | [0-9]{2}\.[0-9]{2}.)
#              REPO=stable
#              ;;
#            *)
#              echo -n "[INFO] '$GITHUB_HEAD_REF' is a non conventional branch name. Please rename it to meet the requirements (MON..., release..., hotfix..., master, main or XX.YY.ZZ)"
#              exit 1
#              ;;
#          esac
#
#
#          for FILE in *.rpm;
#          do
#            VERSION=$(echo $FILE | grep -oP '[0-9]{2}\.[0-9]{2}')
#            DISTRIB=$(echo $FILE | grep -oP 'el[0-9]')
#            ARCH=$(echo $FILE | grep -oP '(x86_64|noarch)')
#            MODULE=$(echo $FILE | grep -oP 'centreon-([a-z]+)')
#
#            echo "Repo: $REPO"
#            echo "Version: $VERSION"
#            echo "Distrib: $DISTRIB"
#            echo "Arch: $ARCH"
#            echo "Module: $MODULE"
#
#            curl -v -u ${{ secrets.REPOS_USERNAME }}:${{ secrets.REPOS_PASSWORD }} --upload-file ./$FILE "https://artifactory.apps.centreon.com/artifactory/rpm-$VERSION-$DISTRIB/$REPO/$ARCH/$MODULE/"
#          done
